using Newtonsoft.Json;
using NoMercy.Database;
using NoMercy.Database.Models;
using NoMercy.NmSystem.Extensions;
using NoMercy.Providers.TMDB.Client;
using NoMercy.Providers.TMDB.Models.Episode;

namespace NoMercy.Api.DTOs.Media;

public class EpisodeDto
{
    [JsonProperty("id")] public long Id { get; set; }
    [JsonProperty("episode_number")] public long EpisodeNumber { get; set; }
    [JsonProperty("season_number")] public long SeasonNumber { get; set; }
    [JsonProperty("title")] public string? Title { get; set; }
    [JsonProperty("overview")] public string? Overview { get; set; }
    [JsonProperty("airDate")] public DateTime? AirDate { get; set; }
    [JsonProperty("still")] public string? Still { get; set; }
    [JsonProperty("color_palette")] public IColorPalettes? ColorPalette { get; set; }
    [JsonProperty("progress")] public object? Progress { get; set; }
    [JsonProperty("available")] public bool Available { get; set; }
    [JsonProperty("tv_id")] public int TvId { get; set; }
    [JsonProperty("translations")] public IEnumerable<TranslationDto> Translations { get; set; } = [];

    [JsonProperty("link")]
    public Uri Link => new($"/tv/{TvId}/watch?season={SeasonNumber}&episode={EpisodeNumber}", UriKind.Relative);

    public EpisodeDto(Episode episode)
    {
        string? title = episode.Translations.FirstOrDefault()?.Title;
        string? overview = episode.Translations.FirstOrDefault()?.Overview;

        VideoFile? videoFile = episode.VideoFiles.FirstOrDefault();
        UserData? userData = videoFile?.UserData.FirstOrDefault();

        TvId = episode.TvId;
        Id = episode.Id;
        Title = !string.IsNullOrEmpty(title)
            ? title
            : episode.Title;
        Overview = !string.IsNullOrEmpty(overview)
            ? overview
            : episode.Overview;
        EpisodeNumber = episode.EpisodeNumber;
        SeasonNumber = episode.SeasonNumber;
        AirDate = episode.AirDate;
        Still = episode.Still;
        ColorPalette = episode.ColorPalette;
        Available = episode.VideoFiles.Count != 0;
        Translations = episode.Translations
            .Select(translation => new TranslationDto(translation));

        Progress = userData?.UpdatedAt is not null && videoFile?.Duration is not null
            ? (int)Math.Round((double)(100 * (userData.Time ?? 0)) / (videoFile.Duration?.ToSeconds() ?? 0))
            : null;
    }

    public EpisodeDto(int tvId, int seasonNumber, int episodeNumber, string language)
    {
        TmdbEpisodeClient tmdbEpisodeClient = new(tvId, seasonNumber, episodeNumber);
        TmdbEpisodeAppends? episodeData = tmdbEpisodeClient.WithAllAppends().Result;

        if (episodeData is null) return;

        string? overview = episodeData.Translations.Translations
            .FirstOrDefault(translation => translation.Iso6391 == language)?
            .Data.Overview;

        Id = episodeData.Id;
        Title = episodeData.Name;
        Overview = !string.IsNullOrEmpty(overview)
            ? overview
            : episodeData.Overview;
        EpisodeNumber = episodeData.EpisodeNumber;
        SeasonNumber = episodeData.SeasonNumber;
        AirDate = episodeData.AirDate;
        Still = episodeData.StillPath;
        ColorPalette = new();
        Available = false;

        Translations = episodeData.Translations.Translations
            .Select(translation => new TranslationDto(translation));
    }
}

public class MissingEpisodeDto(Episode episode) : EpisodeDto(episode)
{
    private readonly Episode _episode = episode;

    [JsonProperty("link")] public new Uri Link => new($"https://www.themoviedb.org/tv/{_episode.TvId}/season/{_episode.SeasonNumber}/episode/{_episode.EpisodeNumber}",
    UriKind.Absolute);

    [JsonProperty("available")] public new bool Available => true;

}