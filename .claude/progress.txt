## EncoderV2 Development Progress

### 2026-02-03: Database Entities Implementation

**Task Completed:** Implement Phase 1 database entities for EncoderV2

**Changes Made:**

1. Created `EncodingJob.cs` in `src/NoMercy.Database/Models/`
   - Entity for encoding jobs with profile reference, input/output paths, state tracking
   - Includes ProfileSnapshotJson for immutable profile state at job creation
   - Supports job states: queued, encoding, completed, failed, cancelled

2. Created `EncodingTask.cs` in `src/NoMercy.Database/Models/`
   - Entity for individual tasks within an encoding job
   - Supports task types: video_encoding, audio_encoding, subtitle_extraction, etc.
   - Includes dependency tracking (DependenciesJson) for task sequencing
   - Retry mechanism with configurable max retries

3. Created `EncoderNode.cs` in `src/NoMercy.Database/Models/`
   - Entity for distributed encoder nodes
   - Tracks hardware capabilities (GPU, CPU cores, memory)
   - Health monitoring with heartbeat tracking
   - Supported hardware acceleration types (NVENC, QSV, VAAPI, etc.)

4. Created `EncodingProgress.cs` in `src/NoMercy.Database/Models/`
   - Entity for progress snapshots during encoding
   - Tracks FPS, speed, bitrate, current time, estimated remaining
   - Supports both frame count and time-based progress

5. Updated `QueueContext.cs`
   - Added DbSet<EncodingJob> EncodingJobs
   - Added DbSet<EncodingTask> EncodingTasks
   - Added DbSet<EncoderNode> EncoderNodes
   - Added DbSet<EncodingProgress> EncodingProgress

**Build Status:**
- NoMercy.Database: BUILD SUCCEEDED
- NoMercy.EncoderV2: BUILD SUCCEEDED

**Next Steps:**
- ~~Create EF Core migration for new tables~~ ✓
- Build ProfileManager with CRUD operations
- Implement profile validation

---

### 2026-02-03: EF Core Migration for EncoderV2 Tables

**Task Completed:** Create EF Core migration for new EncoderV2 tables using `dotnet ef` CLI

**Changes Made:**

1. Added `UlidToStringConverter` to `QueueContext.ConfigureConventions()`
   - Required for Ulid properties in EncoderV2 entities

2. Created `QueueContextDesignTimeFactory.cs`
   - Implements `IDesignTimeDbContextFactory<QueueContext>`
   - Enables migration generation without running the full application

3. Removed `EncoderProfile` navigation property from `EncodingJob`
   - Cross-database reference (QueueContext → MediaContext) not supported
   - ProfileId kept as Ulid? for application-level reference

4. Added `Microsoft.EntityFrameworkCore.Design` package to Server project
   - Required for EF Core CLI tools

5. Generated migration `20260203201619_AddEncoderV2Tables.cs` via CLI:
   ```
   dotnet ef migrations add AddEncoderV2Tables --context QueueContext \
     --output-dir Migrations/Queue --project src/NoMercy.Database \
     --startup-project src/NoMercy.Server
   ```

**Tables Created:**
- `EncoderNodes`: Distributed node registry with hardware capabilities
- `EncodingJobs`: Job tracking with profile snapshots and state management
- `EncodingTasks`: Individual tasks with dependencies, retry logic, node assignment
- `EncodingProgress`: Real-time progress snapshots for monitoring

**Indexes Created:**
- `IX_EncodingProgress_TaskId`
- `IX_EncodingTasks_AssignedNodeId`
- `IX_EncodingTasks_JobId`

**Build Status:**
- NoMercy.Database: BUILD SUCCEEDED

**Next Steps:**
- ~~Build ProfileManager with CRUD operations~~ ✓ (already existed)
- ~~Implement profile validation~~ ✓ (already existed)
- ~~Create default profiles (HLS, MP4, MKV variants)~~ ✓ (already existed)

---

### 2026-02-03: FontExtractor Implementation (Phase 3)

**Task Completed:** Implement FontExtractor for embedded font extraction

**Changes Made:**

1. Created `FontExtractor.cs` in `src/NoMercy.EncoderV2/PostProcessing/`
   - Implements `IFontExtractor` interface for dependency injection
   - Extracts embedded fonts from media files (MKV, ASS/SSA containers)
   - Uses FFmpeg `-dump_attachment:t` command for extraction
   - Generates `fonts.json` manifest with MIME types for web delivery
   - Supports async operations with cancellation tokens

2. Key Features:
   - `ExtractFontsAsync()`: Extracts all fonts and creates manifest
   - `HasFontsAsync()`: Quick check for font presence
   - `GetFontMetadataAsync()`: Get font info without extraction
   - Font detection by MIME type, file extension, and codec name
   - Supports TTF, OTF, WOFF, WOFF2, EOT formats

3. Updated `DependencyInjection.cs`
   - Added `using NoMercy.EncoderV2.PostProcessing;`
   - Registered `IFontExtractor` as scoped service

**Build Status:**
- NoMercy.EncoderV2: BUILD SUCCEEDED
- Full solution: BUILD SUCCEEDED

**Phase 3 Progress (Stream Processing):**
- ✅ VideoStreamProcessor
- ✅ AudioStreamProcessor
- ✅ SubtitleStreamProcessor
- ✅ FontExtractor
- ❌ ChapterProcessor
- ❌ SpriteGenerator

**Next Steps:**
- ~~Implement ChapterProcessor for chapter marker extraction~~ ✓
- Implement SpriteGenerator for thumbnail sprite sheets

---

### 2026-02-03: ChapterProcessor Implementation (Phase 3)

**Task Completed:** Implement ChapterProcessor for chapter extraction to WebVTT

**Changes Made:**

1. Created `ChapterProcessor.cs` in `src/NoMercy.EncoderV2/PostProcessing/`
   - Implements `IChapterProcessor` interface for dependency injection
   - Extracts chapter markers from media files using FFprobe
   - Generates `chapters.vtt` file in WebVTT format for video players
   - Supports MKV, MP4, and other container formats with embedded chapters

2. Key Features:
   - `ExtractChaptersAsync()`: Full extraction with VTT file generation
   - `HasChaptersAsync()`: Quick check for chapter presence
   - `GetChapterMetadataAsync()`: Get chapter info without file generation
   - `WriteChaptersAsync()`: Pipeline-compatible alias for ExtractChaptersAsync
   - Handles missing chapters gracefully (returns success with empty list)
   - Fallback chapter titles ("Chapter N") when title is missing

3. DTOs Created:
   - `ChapterInfo`: Public DTO with Id, Title, StartTime, EndTime
   - `ChapterExtractionResult`: Result object with Success, OutputPath, Chapters, ErrorMessage
   - `FfprobeChapterRoot`, `FfprobeChapter`, `FfprobeTags`: Internal DTOs for JSON parsing

4. Updated `ServiceCollectionExtensions.cs`
   - Added `using NoMercy.EncoderV2.PostProcessing;`
   - Registered `IChapterProcessor` as scoped service

**Build Status:**
- NoMercy.EncoderV2: BUILD SUCCEEDED

**Phase 3 Progress (Stream Processing):**
- ✅ VideoStreamProcessor
- ✅ AudioStreamProcessor
- ✅ SubtitleStreamProcessor
- ✅ FontExtractor
- ✅ ChapterProcessor
- ❌ SpriteGenerator

**Next Steps:**
- ~~Implement SpriteGenerator for thumbnail sprite sheets~~ ✓

---

### 2026-02-03: SpriteGenerator Implementation (Phase 3 Complete)

**Task Completed:** Implement SpriteGenerator for thumbnail sprite sheet generation

**Changes Made:**

1. Created `SpriteGenerator.cs` in `src/NoMercy.EncoderV2/PostProcessing/`
   - Implements `ISpriteGenerator` interface for dependency injection
   - Extracts thumbnails from media files at configurable intervals
   - Combines thumbnails into WebP sprite sheet using FFmpeg tile filter
   - Generates WebVTT file with xywh fragment identifiers for video player scrubbing

2. Key Features:
   - `GenerateSpriteAsync()`: Full extraction from media file with configurable dimensions/interval
   - `GenerateSpriteFromThumbnailsAsync()`: Create sprite from pre-extracted thumbnails
   - `GetDurationAsync()`: Query media file duration using FFprobe
   - `CalculateSpriteMetadata()`: Calculate grid dimensions and frame positions
   - Automatic cleanup of individual thumbnail files after sprite generation
   - Support for aspect ratio preservation when height is not specified

3. DTOs Created:
   - `SpriteFrame`: Individual frame info with index, timestamp, x, y, width, height
   - `SpriteMetadata`: Complete sprite info including grid dimensions and frame list
   - `SpriteGenerationResult`: Result object with Success, file paths, metadata, ErrorMessage
   - `FfprobeDurationRoot`, `FfprobeDurationFormat`: Internal DTOs for duration parsing

4. Updated DI Configuration:
   - Added `ISpriteGenerator` registration to `Composition/DependencyInjection.cs`
   - Added `ISpriteGenerator` registration to `DependencyInjection/ServiceCollectionExtensions.cs`
   - Both registered as scoped services (one per encoding job)

**Build Status:**
- NoMercy.EncoderV2: BUILD SUCCEEDED

**Phase 3 Progress (Stream Processing) - COMPLETE:**
- ✅ VideoStreamProcessor
- ✅ AudioStreamProcessor
- ✅ SubtitleStreamProcessor
- ✅ FontExtractor
- ✅ ChapterProcessor
- ✅ SpriteGenerator

**Next Steps (Phase 4: FFmpeg Integration):**
- ~~Implement FFmpegCommandBuilder~~ ✓ (already existed)
- ~~Implement HDRProcessor (HDR→SDR tonemap)~~ ✓
- ~~Implement ProgressMonitor (FFmpeg `-progress -` parsing)~~ ✓ (already existed)
- ~~Implement EncodingJobExecutor~~ ✓ (already existed)
- Implement PostProcessor

---

### 2026-02-03: HDRProcessor Implementation (Phase 4)

**Task Completed:** Implement HDRProcessor for HDR detection and tone mapping

**Changes Made:**

1. Created `IHdrProcessor.cs` in `src/NoMercy.EncoderV2/Processing/`
   - Interface for HDR detection and processing
   - Enums for HDR formats: HDR10, HDR10+, HLG, Dolby Vision
   - Enums for tone mapping algorithms: Hable, Reinhard, Mobius, BT.2390, Linear
   - Hardware acceleration options: CUDA, OpenCL, Vulkan
   - DTOs: HdrDetectionResult, HdrConversionResult, HdrProcessingOptions

2. Created `HdrProcessor.cs` in `src/NoMercy.EncoderV2/Processing/`
   - Implements `IHdrProcessor` interface for dependency injection
   - HDR detection via FFprobe with JSON parsing and regex fallback
   - Multiple tone mapping algorithm support with configurable parameters
   - Software tone mapping using zscale and tonemap filters
   - Hardware-accelerated filter chains for CUDA/OpenCL/Vulkan
   - SDR cache mechanism for sharing converted files across quality levels (PRD G8)
   - Recommended algorithm selection based on HDR format

3. Key Features:
   - `DetectHdrAsync()`: Analyzes media for HDR format, color space, and metadata
   - `ConvertToSdrAsync()`: Full HDR→SDR conversion with progress callback
   - `BuildToneMappingFilterChain()`: Builds FFmpeg filter string for tone mapping
   - `GetCachedSdrPath()`: Checks for cached SDR versions to avoid re-processing
   - `GetRecommendedAlgorithm()`: Returns best algorithm per HDR format
   - MaxCLL/MaxFALL metadata extraction
   - Master display color volume parsing
   - Dolby Vision side data detection

4. Updated DI Configuration:
   - Added `using NoMercy.EncoderV2.Processing;` to both DI files
   - Registered `IHdrProcessor` as scoped service in both configurations

**Build Status:**
- NoMercy.EncoderV2: BUILD SUCCEEDED

**Phase 4 Progress (FFmpeg Integration):**
- ✅ FFmpegCommandBuilder (pre-existing)
- ✅ HDRProcessor
- ✅ ProgressMonitor (pre-existing)
- ✅ EncodingJobExecutor (pre-existing)
- ❌ PostProcessor

**Next Steps:**
- ~~Implement PostProcessor for post-encoding tasks~~ ✓

---

### 2026-02-03: PostProcessor Implementation (Phase 4 Complete)

**Task Completed:** Implement PostProcessor for post-encoding orchestration

**Changes Made:**

1. Created `PostProcessor.cs` in `src/NoMercy.EncoderV2/PostProcessing/`
   - Implements `IPostProcessor` interface for dependency injection
   - Orchestrates all post-processing steps after encoding completes
   - Configurable via `PostProcessingOptions` for enabling/disabling features
   - Progress callback support for real-time UI updates

2. Key Features:
   - `ProcessAsync()`: Executes all enabled post-processing steps in sequence
   - `ExtractFontsAsync()`: Delegates to `IFontExtractor`
   - `ExtractChaptersAsync()`: Delegates to `IChapterProcessor`
   - `GenerateSpritesAsync()`: Delegates to `ISpriteGenerator`
   - `ValidateOutputAsync()`: Validates encoded output files and playlists
   - Master playlist generation for HLS from existing variant playlists
   - Parses video/audio folder naming conventions (video_1920x1080_SDR, audio_eng_aac)
   - Bandwidth estimation based on resolution and HDR status

3. DTOs Created:
   - `PostProcessingStepResult`: Individual step outcome with timing and metadata
   - `PostProcessingResult`: Aggregated result with all step outcomes
   - `PostProcessingOptions`: Configuration for enabling/disabling steps

4. Post-Processing Steps (in order):
   1. Font Extraction → fonts/ directory + fonts.json
   2. Chapter Extraction → chapters.vtt
   3. Sprite Generation → thumbs_*.webp + thumbs_*.vtt
   4. Output Validation → Verify playlists and media files
   5. Master Playlist Generation → {filename}.m3u8 (HLS only)

5. Updated Project Configuration:
   - Re-enabled `Validation/`, `Specifications/`, and `Streams/` folders in csproj
   - Only excludes specific files with actual broken dependencies:
     - `Validation/CodecValidator.cs` (needs IFFmpegService)
     - `Validation/ProfileValidator.cs` (needs excluded types)
     - `Validation/Rules/**/*.cs`

6. Updated DI Configuration:
   - Added `IOutputValidator`, `IHLSPlaylistGenerator` registrations
   - Added `IPostProcessor` registration as scoped service
   - Both `Composition/DependencyInjection.cs` and `DependencyInjection/ServiceCollectionExtensions.cs`

**Build Status:**
- NoMercy.EncoderV2: BUILD SUCCEEDED

**Phase 4 Progress (FFmpeg Integration) - COMPLETE:**
- ✅ FFmpegCommandBuilder (pre-existing)
- ✅ HDRProcessor
- ✅ ProgressMonitor (pre-existing)
- ✅ EncodingJobExecutor (pre-existing)
- ✅ PostProcessor

**Next Steps (Phase 5: Task Distribution):**
- ~~Implement TaskSplitter (Job → Task decomposition)~~ ✓
- Implement NodeSelector (capability matching)
- Implement JobDispatcher (queue integration)
- Implement NodeHealthMonitor (30-second health checks)

---

### 2026-02-03: TaskSplitter Implementation (Phase 5)

**Task Completed:** Implement TaskSplitter for job-to-task decomposition

**Changes Made:**

1. Enhanced `ITaskSplitter.cs` in `src/NoMercy.EncoderV2/Tasks/`
   - Added `TaskSplittingOptions` for configurable splitting behavior
   - Added `TaskSplitResult` with metadata (parallelism, critical path, HDR sharing)
   - Added `Optimal` strategy that auto-selects best approach
   - Extended `EncodingTaskDefinition` with Id, Description, OutputPath, RequiresGpu, EstimatedMemoryMb
   - Added `DetermineOptimalStrategy()` method
   - Added `ToEncodingTasks()` for database entity conversion

2. Implemented `TaskSplitter.cs` with full job decomposition:
   - **SingleTask Strategy**: Full encode as one task (simple jobs)
   - **ByResolution Strategy**: Separate task per quality level (multi-quality encoding)
   - **ByStreamType Strategy**: Split video/audio/subtitle processing
   - **BySegment Strategy**: Time-based splitting for long HLS content
   - **Optimal Strategy**: Auto-selects based on source characteristics

3. Key Features:
   - Shared HDR conversion task (PRD G8: HDR→SDR executed once, shared across qualities)
   - Post-processing tasks: fonts, chapters, sprites, validation, playlist generation
   - Task dependency tracking with DAG support
   - Weight calculation using `TaskWeighting` utilities
   - Hardware requirements tracking (GPU, memory estimates)
   - Uses proper `EncodingTaskType` constants from database models
   - Language-based audio task splitting option

4. Updated Project Configuration (`NoMercy.EncoderV2.csproj`):
   - Enabled `Tasks/ITaskSplitter.cs` and `Tasks/TaskSplitter.cs`
   - Enabled `Core/TaskWeighting.cs`
   - Excluded other Tasks/*.cs files with broken dependencies

5. Updated DI Configuration:
   - Added `using NoMercy.EncoderV2.Tasks;` to ServiceCollectionExtensions.cs
   - Registered `ITaskSplitter` as scoped service

**Task Distribution Strategies:**
| Strategy | Best For | Example |
|----------|----------|---------|
| SingleTask | Simple 1-quality jobs | Single 1080p output |
| ByResolution | Multi-quality encoding | 4K + 1080p + 720p outputs |
| ByStreamType | Parallel video/audio | When tasks can run independently |
| BySegment | Very long HLS content | >2 hour movies |
| Optimal | Any job | Auto-selects based on analysis |

**Build Status:**
- NoMercy.EncoderV2: BUILD SUCCEEDED

**Phase 5 Progress (Task Distribution):**
- ✅ TaskSplitter (Job → Task decomposition)
- ✅ NodeSelector (capability matching)
- ❌ JobDispatcher (queue integration)
- ❌ NodeHealthMonitor (30-second health checks)

**Next Steps:**
- ~~Implement NodeSelector for capability-based node matching~~ ✓

---

### 2026-02-03: NodeSelector Implementation (Phase 5)

**Task Completed:** Implement NodeSelector for capability-based node matching

**Changes Made:**

1. Created `INodeSelector.cs` in `src/NoMercy.EncoderV2/Tasks/`
   - Interface for node selection and capability matching
   - Enums for selection strategies: LeastLoaded, BestCapability, RoundRobin, Fastest, Auto
   - DTOs for selection options, results, and batch assignments:
     - `NodeSelectionOptions`: Strategy, GPU requirements, memory, heartbeat age
     - `NodeSelectionResult`: Selected node with score, alternatives, reason
     - `NodeCandidate`: Node with score breakdown and warnings
     - `BatchAssignmentResult`: For assigning multiple tasks
     - `TaskAssignment`, `UnassignedTask`: Individual assignment results

2. Implemented `NodeSelector.cs` with capability matching:
   - **LeastLoaded Strategy**: Select node with lowest current load percentage
   - **BestCapability Strategy**: Select node with highest hardware score
   - **RoundRobin Strategy**: Distribute tasks evenly across nodes
   - **Fastest Strategy**: Prefer GPU nodes, then highest CPU cores
   - **Auto Strategy**: Automatically choose based on task characteristics

3. Key Features:
   - `SelectNode()`: Select best node for a single task
   - `SelectNodesForTasks()`: Batch assignment with capacity tracking
   - `CanNodeHandleTask()`: Check if node meets task requirements
   - `CalculateNodeScore()`: Weighted scoring across multiple factors
   - `GetCapableNodes()`: List all nodes that can handle a task
   - `FilterHealthyNodes()`: Filter by heartbeat age
   - `DetermineOptimalStrategy()`: Auto-select strategy per task type

4. Scoring System (weighted factors):
   - GPU Match: 30% (NVIDIA bonus, GPU requirement match)
   - Capacity: 25% (available slots vs max concurrent tasks)
   - Memory: 15% (meets requirement + excess ratio)
   - CPU: 15% (normalized core count)
   - Acceleration: 15% (NVENC, QSV, VAAPI, VideoToolbox support)

5. Health Checks:
   - Node enabled/healthy status
   - Last heartbeat age validation (configurable, default 60s)
   - Capacity check (exclude full nodes option)
   - Memory requirement validation

6. Updated DI Configuration:
   - Added `INodeSelector` registration to `DependencyInjection/ServiceCollectionExtensions.cs`
   - Added `INodeSelector` registration to `Composition/DependencyInjection.cs`
   - Both registered as scoped services

**Build Status:**
- NoMercy.EncoderV2: BUILD SUCCEEDED

**Phase 5 Progress (Task Distribution):**
- ✅ TaskSplitter (Job → Task decomposition)
- ✅ NodeSelector (capability matching)
- ✅ JobDispatcher (queue integration)
- ❌ NodeHealthMonitor (30-second health checks)

**Next Steps:**
- ~~Implement JobDispatcher for queue integration~~ ✓

---

### 2026-02-03: JobDispatcher Implementation (Phase 5)

**Task Completed:** Implement JobDispatcher for queue integration

**Changes Made:**

1. Created `IJobDispatcher.cs` in `src/NoMercy.EncoderV2/Tasks/`
   - Interface for encoding job dispatching and management
   - Enums: `JobPriority` (Low, Normal, High, Urgent)
   - DTOs for dispatch options, results, and status:
     - `JobDispatchOptions`: Priority, split/node strategies, post-processing flags
     - `JobDispatchResult`: Success, job, tasks, weights, unassigned tasks
     - `JobCancelResult`: Success, cancelled/completed counts
     - `TaskRetryResult`: Success, retried count, exceeded max retries
     - `JobStatus`: Progress aggregation across all tasks

2. Implemented `JobDispatcher.cs` with full queue integration:
   - **Job Dispatch**: Create job, analyze media, split into tasks, optionally assign nodes
   - **Job Cancellation**: Cancel all pending tasks, update job state
   - **Task Retry**: Retry failed tasks with retry counting, reset job state
   - **Status Queries**: Get job status with aggregated progress from tasks
   - **Task Lifecycle**: Start, complete, fail tasks with node tracking
   - **Node Failure Handling**: Reassign tasks from unhealthy nodes
   - **Dependency Tracking**: Check task dependencies before execution

3. Key Features:
   - `DispatchAsync()`: Create job from profile, split tasks, optional node assignment
   - `CancelJobAsync()`: Cancel job and all non-completed tasks
   - `RetryFailedTasksAsync()`: Retry failed tasks respecting max retries
   - `GetJobStatusAsync()`: Aggregate progress with ETA calculation
   - `GetNextPendingTaskAsync()`: Get next executable task respecting dependencies
   - `AssignTaskToNodeAsync()`: Manually assign task to specific node
   - `StartTaskAsync()`: Mark task as running, update job state
   - `CompleteTaskAsync()`: Mark task complete, check job completion
   - `FailTaskAsync()`: Mark task failed, update job state if no remaining tasks
   - `RecordProgressAsync()`: Store progress snapshot for task
   - `ReassignTasksFromNodeAsync()`: Handle node failures gracefully

4. Integration Points:
   - Uses `ITaskSplitter` for job-to-task decomposition
   - Uses `INodeSelector` for batch task-to-node assignment
   - Uses `IStreamAnalyzer` for media file analysis
   - Uses `IProfileRepository` for profile lookup from database
   - Uses `QueueContext` for all database operations

5. Updated Project Configuration:
   - Enabled `ProfileRepository.cs` in csproj for profile access
   - Added `IJobDispatcher`, `IStreamAnalyzer`, `IProfileRepository` to DI

**Build Status:**
- NoMercy.EncoderV2: BUILD SUCCEEDED
- Full Solution: BUILD SUCCEEDED

**Phase 5 Progress (Task Distribution):**
- ✅ TaskSplitter (Job → Task decomposition)
- ✅ NodeSelector (capability matching)
- ✅ JobDispatcher (queue integration)
- ✅ NodeHealthMonitor (30-second health checks)

**Next Steps:**
- ~~Implement NodeHealthMonitor for 30-second health checks~~ ✓

---

### 2026-02-03: NodeHealthMonitor Implementation (Phase 5 Complete)

**Task Completed:** Implement NodeHealthMonitor for 30-second health checks

**Changes Made:**

1. Created `INodeHealthMonitor.cs` in `src/NoMercy.EncoderV2/Tasks/`
   - Interface for node health monitoring with comprehensive API
   - DTOs: `HealthCheckResult`, `NodeHealthStatus`, `HealthMonitorOptions`, `HeartbeatResult`
   - Operations: start/stop monitoring, health checks, heartbeat recording
   - Node management: enable, disable, mark healthy/unhealthy
   - Status queries: all nodes, single node, summary statistics

2. Implemented `NodeHealthMonitor.cs` as BackgroundService:
   - Inherits from `BackgroundService` for ASP.NET Core hosted service integration
   - 30-second periodic health checks (configurable via `HealthMonitorOptions`)
   - Heartbeat-based health detection with 60-second timeout (configurable)
   - Automatic task reassignment from unhealthy nodes

3. Key Features:
   - `PerformHealthCheckAsync()`: Check all nodes, update IsHealthy, reassign tasks
   - `RecordHeartbeatAsync()`: Record heartbeat from node, mark as healthy
   - `MarkNodeUnhealthyAsync()`: Manually mark node unhealthy with task reassignment
   - `MarkNodeHealthyAsync()`: Manually mark node healthy
   - `EnableNodeAsync()`: Enable node for task assignment
   - `DisableNodeAsync()`: Disable node with task reassignment
   - `GetAllNodeStatusesAsync()`: Get detailed status of all nodes
   - `GetNodeStatusAsync()`: Get status of specific node
   - `GetNodeSummaryAsync()`: Quick statistics (total, healthy, enabled, running tasks)

4. Health Detection Logic:
   - Nodes with heartbeat older than timeout are marked unhealthy
   - Hysteresis via `_consecutiveFailedChecks` prevents flapping
   - Configurable `FailedChecksBeforeUnhealthy` (default: 2)
   - New nodes without heartbeat get grace period (2x timeout)

5. Updated DI Configuration:
   - `ServiceCollectionExtensions.cs`: Added `HealthMonitorOptions` from `EncoderV2Options`
   - `ServiceCollectionExtensions.cs`: Registered `NodeHealthMonitor` as singleton and hosted service
   - `Composition/DependencyInjection.cs`: Added same registrations
   - Added health monitoring options to `EncoderV2Options`

6. EncoderV2Options Extended:
   - `HealthCheckIntervalSeconds` (default: 30)
   - `HeartbeatTimeoutSeconds` (default: 60)
   - `AutoReassignTasksOnNodeFailure` (default: true)
   - `VerboseHealthLogging` (default: false)

**Build Status:**
- NoMercy.EncoderV2: BUILD SUCCEEDED
- Full Solution: BUILD SUCCEEDED

**Phase 5 Progress (Task Distribution) - COMPLETE:**
- ✅ TaskSplitter (Job → Task decomposition)
- ✅ NodeSelector (capability matching)
- ✅ JobDispatcher (queue integration)
- ✅ NodeHealthMonitor (30-second health checks)

**Next Steps (Phase 6: Node Implementation):**
- ~~Create EncoderNode project~~ ✓ (already existed)
- ~~Implement NodeRegistration (phone-home + mDNS)~~ ✓ (already existed)
- ~~Implement node-side ProgressEmitter~~ ✓
- ~~Implement NodeCapabilities (GPU/CPU detection)~~ ✓ (already existed)

---

### 2026-02-03: ProgressEmitter Implementation (Phase 6)

**Task Completed:** Implement node-side ProgressEmitter for FFmpeg progress reporting

**Changes Made:**

1. Created `ProgressEmitter.cs` in `src/NoMercy.EncoderNode/Services/`
   - Implements `IProgressEmitter` interface for dependency injection
   - Parses FFmpeg progress output (frame, fps, time, bitrate, speed)
   - Supports both standard stderr output and -progress pipe:1 format
   - Throttles progress reports (default 1 second interval)
   - Reports task started/completed events to primary server
   - Calculates estimated time remaining based on encoding speed
   - HTTP-based progress reporting with Bearer token authentication

2. Key Features:
   - `ParseAndEmitAsync()`: Parse FFmpeg output and emit progress
   - `EmitProgressAsync()`: Send progress data to server with throttling
   - `CreateProgressCallback()`: Create callback for FFmpeg process integration
   - `ParseProgressLine()`: Extract metrics from FFmpeg stderr lines
   - `ReportTaskStartedAsync()`: Notify server when task begins
   - `ReportTaskCompletedAsync()`: Notify server when task ends
   - Throttling prevents overwhelming server with updates
   - Supports both user tokens and Keycloak service tokens

3. Created supporting NmSystem utilities:
   - `FFmpegAccelerationDetector.cs`: Detect available hardware acceleration
   - `GpuDeviceDetector.cs`: Detect GPU devices and capabilities
   - `Memory.cs`: System memory information (total/available)
   - Made `Cpu.Names()` public for cross-project access
   - Added `ServerHardwareCapabilities` DTO to EncoderNodeDtos.cs

4. Updated `EncoderNodeOptions.cs`:
   - Added `ProgressReportIntervalMs` (default: 1000ms)
   - Added `LogProgress` flag for console logging

5. Updated `Program.cs` DI configuration:
   - Registered `IProgressEmitter` as singleton
   - Registered `IKeycloakAuthService`, `IServerDiscoveryService`
   - Registered `NodeRegistrationService` as hosted service
   - Added `HttpClient` factory

**Build Status:**
- NoMercy.EncoderNode: BUILD SUCCEEDED
- NoMercy.NmSystem: BUILD SUCCEEDED

**Phase 6 Progress (Node Implementation) - COMPLETE:**
- ✅ EncoderNode project (pre-existing)
- ✅ NodeRegistration (pre-existing)
- ✅ ProgressEmitter
- ✅ NodeCapabilities (pre-existing via CapabilityDetector)

**Next Steps (Phase 7: API & Integration):**
- ~~Create ProfileController (CRUD endpoints)~~ ✓
- Create EncodingController (job submission)
- Create ProgressHub (SignalR real-time updates)
- Integrate with existing Queue system
- Add API documentation (Swagger)

---

### 2026-02-03: ProfilesController Implementation (Phase 7)

**Task Completed:** Create ProfilesController for EncoderV2 CRUD endpoints

**Changes Made:**

1. Created `ProfilesController.cs` in `src/NoMercy.Api/Controllers/V2/Dashboard/`
   - REST API v2 controller for encoding profile management
   - Inherits from `BaseController` for standardized error responses
   - Uses `[ApiVersion(2.0)]` for API versioning
   - Uses `IProfileRepository` from EncoderV2 for database operations
   - Requires moderator authorization for all endpoints

2. Endpoints Implemented:
   - `GET /api/v2/dashboard/encoder/profiles` - List all profiles
   - `GET /api/v2/dashboard/encoder/profiles/{id}` - Get profile by ULID
   - `POST /api/v2/dashboard/encoder/profiles` - Create new profile
   - `PATCH /api/v2/dashboard/encoder/profiles/{id}` - Update existing profile
   - `DELETE /api/v2/dashboard/encoder/profiles/{id}` - Delete profile
   - `GET /api/v2/dashboard/encoder/profiles/default` - Get default profile
   - `POST /api/v2/dashboard/encoder/profiles/{id}/duplicate` - Duplicate profile

3. Request DTOs Created:
   - `CreateProfileRequest`: Name (required), Container, Param, VideoProfiles, AudioProfiles, SubtitleProfiles
   - `UpdateProfileRequest`: All fields optional for partial updates
   - `DuplicateProfileRequest`: Optional new name for duplicated profile

4. Updated `NoMercy.Api.csproj`:
   - Added project reference to `NoMercy.EncoderV2`

**API Response Format:**
All endpoints return `StatusResponseDto<T>` with:
- `status`: "ok" or "error"
- `data`: Response payload
- `message`: Human-readable message
- `args`: Message interpolation arguments

**Build Status:**
- NoMercy.Api: BUILD SUCCEEDED

**Phase 7 Progress (API & Integration):**
- ✅ ProfileController (CRUD endpoints)
- ✅ EncodingController (job submission)
- ✅ ProgressHub (SignalR real-time updates)
- ✅ Integrate with existing Queue system
- ❌ Add API documentation (Swagger)

**Next Steps:**
- Add API documentation (Swagger)

---

### 2026-02-03: EncodingController Implementation (Phase 7)

**Task Completed:** Create EncodingController for job submission endpoints

**Changes Made:**

1. Created `EncodingController.cs` in `src/NoMercy.Api/Controllers/V2/Dashboard/`
   - REST API v2 controller for encoding job management
   - Inherits from `BaseController` for standardized error responses
   - Uses `[ApiVersion(2.0)]` for API versioning
   - Uses `IJobDispatcher` from EncoderV2 for job operations
   - Requires moderator authorization for all endpoints

2. Job Management Endpoints:
   - `GET /api/v2/dashboard/encoder/jobs` - List all jobs with optional state filter
   - `GET /api/v2/dashboard/encoder/jobs/{id}` - Get job status with progress details
   - `POST /api/v2/dashboard/encoder/jobs` - Submit new encoding job
   - `POST /api/v2/dashboard/encoder/jobs/{id}/cancel` - Cancel job and pending tasks
   - `POST /api/v2/dashboard/encoder/jobs/{id}/retry` - Retry failed tasks

3. Task Management Endpoints (for encoder nodes):
   - `GET /api/v2/dashboard/encoder/jobs/tasks/next` - Get next pending task
   - `POST /api/v2/dashboard/encoder/jobs/tasks/{taskId}/assign` - Assign task to node
   - `POST /api/v2/dashboard/encoder/jobs/tasks/{taskId}/start` - Mark task as started
   - `POST /api/v2/dashboard/encoder/jobs/tasks/{taskId}/complete` - Mark task as completed
   - `POST /api/v2/dashboard/encoder/jobs/tasks/{taskId}/fail` - Mark task as failed
   - `POST /api/v2/dashboard/encoder/jobs/tasks/{taskId}/progress` - Record task progress

4. Request DTOs Created:
   - `SubmitJobRequest`: Job submission with profile, priority, strategies, options
   - `AssignTaskRequest`: Task-to-node assignment
   - `CompleteTaskRequest`: Task completion with optional output file
   - `FailTaskRequest`: Task failure with error message
   - `RecordProgressRequest`: Progress data (fps, speed, bitrate, time, frames)

**Build Status:**
- NoMercy.Api: BUILD SUCCEEDED

**Phase 7 Progress (API & Integration):**
- ✅ ProfileController (CRUD endpoints)
- ✅ EncodingController (job submission)
- ✅ ProgressHub (SignalR real-time updates)
- ✅ Integrate with existing Queue system
- ❌ Add API documentation (Swagger)

**Next Steps:**
- Add API documentation (Swagger)

---

### 2026-02-03: EncodingProgressHub Implementation (Phase 7)

**Task Completed:** Create ProgressHub for SignalR real-time encoding updates

**Changes Made:**

1. Created `EncodingProgressHub.cs` in `src/NoMercy.Api/Controllers/Socket/`
   - SignalR hub for real-time encoding progress updates
   - Inherits from `ConnectionHub` for authenticated WebSocket connections
   - Group-based subscription model for targeted updates

2. Client Subscription Methods:
   - `SubscribeToJob(jobId)` / `UnsubscribeFromJob(jobId)` - Track specific job
   - `SubscribeToAllJobs()` / `UnsubscribeFromAllJobs()` - Monitor all encoding activity
   - `SubscribeToNodes()` / `UnsubscribeFromNodes()` - Track encoder node status

3. Query Methods:
   - `GetJobStatus(jobId)` - Get current status of specific job
   - `GetActiveJobs()` - Get all jobs in queued/encoding state
   - `GetNodeStatuses()` - Get status of all encoder nodes

4. Created `EncodingProgressHubService.cs` for server-side broadcasting:
   - `IEncodingProgressHubService` interface for DI
   - Uses `IHubContext<EncodingProgressHub>` for external message broadcasting
   - Broadcast methods:
     - `SendTaskProgressAsync()` - Progress metrics (FPS, speed, bitrate, ETA)
     - `SendJobStateChangeAsync()` - Job state transitions
     - `SendTaskStateChangeAsync()` - Task state transitions
     - `SendNodeStatusChangeAsync()` - Node health changes
     - `SendJobCreatedAsync()` - New job notifications
     - `SendJobRemovedAsync()` - Job deletion/cancellation

5. DTOs for SignalR Messages:
   - `TaskProgressUpdate`: Progress percentage, FPS, speed, bitrate, current time, ETA
   - `JobStateChange`: Previous state, new state, error message, timestamp
   - `TaskStateChange`: Task type, states, assigned node, error message
   - `NodeStatusChange`: Node health, enabled status, last heartbeat
   - `EncodingJobStatusDto`: Full job status with task breakdown
   - `EncodingTaskStatusDto`: Individual task status
   - `EncoderNodeStatusDto`: Node capabilities and current load

6. Created `EncodingProgressHubServiceExtensions.cs` in Server project:
   - `AddEncodingProgressHubServices()` extension method for DI registration
   - Registers `EncodingProgressHub` as scoped
   - Registers `IEncodingProgressHubService` as singleton

7. Updated `ApplicationConfiguration.cs`:
   - Mapped hub endpoint at `/encodingProgressHub`
   - WebSocket transport with 40-second timeout
   - Authentication expiration handling

8. Updated `ServiceConfiguration.cs`:
   - Added `AddEncodingProgressHubServices()` call

**SignalR Events (Client-Side):**
| Event | Description | Payload |
|-------|-------------|---------|
| `TaskProgress` | Progress update | `TaskProgressUpdate` |
| `JobStateChanged` | Job state transition | `JobStateChange` |
| `TaskStateChanged` | Task state transition | `TaskStateChange` |
| `NodeStatusChanged` | Node health change | `NodeStatusChange` |
| `JobCreated` | New job created | `EncodingJobStatusDto` |
| `JobRemoved` | Job deleted/cancelled | `{ jobId, reason }` |

**Build Status:**
- NoMercy.Server: BUILD SUCCEEDED
- Full Solution: BUILD SUCCEEDED

**Phase 7 Progress (API & Integration):**
- ✅ ProfileController (CRUD endpoints)
- ✅ EncodingController (job submission)
- ✅ ProgressHub (SignalR real-time updates)
- ✅ Integrate with existing Queue system
- ❌ Add API documentation (Swagger)

**Next Steps:**
- Add API documentation (Swagger)

---

### 2026-02-03: Queue System Integration (Phase 7)

**Task Completed:** Integrate EncoderV2 with existing Queue system

**Changes Made:**

1. Created `EncoderV2TaskWorker.cs` in `src/NoMercy.EncoderV2/Workers/`
   - BackgroundService that polls QueueContext for pending EncodingTask records
   - Configurable concurrent task execution via `EncoderV2WorkerOptions`
   - Task-specific execution handlers for all EncodingTaskType variants:
     - VideoEncoding, AudioEncoding, SubtitleExtraction
     - FontExtraction, ChapterExtraction, SpriteGeneration
     - HdrConversion, PlaylistGeneration, Validation
   - Progress broadcasting to SignalR clients during task execution
   - Graceful shutdown with running task completion

2. Created `IEncodingProgressBroadcaster.cs` interface:
   - Defines contract for broadcasting progress updates
   - Methods: SendTaskProgressAsync, SendTaskStateChangeAsync,
     SendJobStateChangeAsync, SendNodeStatusChangeAsync,
     SendJobCreatedAsync, SendJobRemovedAsync

3. Created `IEncodingTaskExecutor.cs` interface:
   - Optional interface for custom task executors
   - Allows injection of specialized task handling

4. Created `EncodingProgressBroadcasterAdapter.cs` in Server project:
   - Implements `IEncodingProgressBroadcaster`
   - Bridges EncoderV2 worker with `IEncodingProgressHubService`
   - Maps EncodingProgress entities to SignalR DTOs

5. Updated `ServiceCollectionExtensions.cs`:
   - Added `AddEncoderV2TaskWorker()` extension methods
   - Supports custom `EncoderV2WorkerOptions` configuration
   - Registers worker as hosted service

6. Updated `EncodingProgressHubServiceExtensions.cs`:
   - Added `IEncodingProgressBroadcaster` registration
   - Added `AddEncoderV2()` and `AddEncoderV2TaskWorker()` calls
   - Default configuration: single concurrent task, 1s polling interval

7. Added project reference in `NoMercy.Server.csproj`:
   - Reference to `NoMercy.EncoderV2` project

**Worker Configuration:**
```csharp
services.AddEncoderV2TaskWorker(options =>
{
    options.MaxConcurrentTasks = 1;
    options.PollingIntervalMs = 1000;
    options.LocalTasksOnly = true;
});
```

**Integration Architecture:**
```
+-------------------------------------------------------------+
| NoMercy.Server                                               |
+-------------------------------------------------------------+
| EncoderV2TaskWorker (BackgroundService)                     |
|   +-- Polls QueueContext.EncodingTasks                      |
|   +-- Uses IJobDispatcher to manage task lifecycle          |
|   +-- Broadcasts via IEncodingProgressBroadcaster           |
|                                                              |
| EncodingProgressBroadcasterAdapter                          |
|   +-- Implements IEncodingProgressBroadcaster               |
|   +-- Delegates to IEncodingProgressHubService (SignalR)    |
|                                                              |
| EncodingProgressHub                                          |
|   +-- WebSocket endpoint for real-time updates              |
+-------------------------------------------------------------+
```

**Build Status:**
- NoMercy.EncoderV2: BUILD SUCCEEDED
- NoMercy.Server: BUILD SUCCEEDED

**Phase 7 Progress (API & Integration):**
- ✅ ProfileController (CRUD endpoints)
- ✅ EncodingController (job submission)
- ✅ ProgressHub (SignalR real-time updates)
- ✅ Integrate with existing Queue system
- ✅ Add API documentation (Swagger)

**Phase 7 Complete - Next: Phase 8 (Testing & Validation)**

---

### 2026-02-04: Swagger API Documentation (Phase 7 Complete)

**Task Completed:** Add API documentation (Swagger) for EncoderV2 endpoints

**Changes Made:**

1. Enabled XML documentation generation in project files:
   - `NoMercy.Api.csproj`: Added `<GenerateDocumentationFile>true</GenerateDocumentationFile>`
   - `NoMercy.EncoderV2.csproj`: Added `<GenerateDocumentationFile>true</GenerateDocumentationFile>`
   - `NoMercy.Database.csproj`: Added `<GenerateDocumentationFile>true</GenerateDocumentationFile>`
   - Suppressed warning 1591 (missing XML comments) with `<NoWarn>$(NoWarn);1591</NoWarn>`

2. Updated `ServiceConfiguration.cs`:
   - Configured `AddSwaggerGen()` to include XML comments from:
     - `NoMercy.Api.xml` (controller documentation)
     - `NoMercy.EncoderV2.xml` (DTO and service documentation)
     - `NoMercy.Database.xml` (model documentation)
   - XML files are loaded conditionally (only if they exist)

3. Updated `ConfigureSwaggerOptions.cs`:
   - Added version-specific API descriptions
   - v1: Core API for media library management
   - v2: Enhanced API with EncoderV2 distributed encoding system
   - Included EncoderV2 feature highlights:
     - Profiles: Encoding profile management
     - Jobs: Job submission and control
     - Tasks: Distributed task execution
     - Real-time Updates: SignalR hub documentation
   - Authentication requirements documented

**Swagger Documentation Features:**
- XML comments from controllers appear in Swagger UI descriptions
- Request/Response DTOs have documented properties
- `[ProducesResponseType]` attributes show expected HTTP status codes
- Version-specific descriptions help users understand API capabilities
- SignalR hub endpoint (`/encodingProgressHub`) documented

**Build Status:**
- NoMercy.Api: BUILD SUCCEEDED (XML generated: 47KB)
- NoMercy.EncoderV2: BUILD SUCCEEDED (XML generated: 214KB)
- NoMercy.Database: BUILD SUCCEEDED (XML generated: 14KB)
- NoMercy.Server: BUILD SUCCEEDED

**Phase 7 Progress (API & Integration) - COMPLETE:**
- ✅ ProfileController (CRUD endpoints)
- ✅ EncodingController (job submission)
- ✅ ProgressHub (SignalR real-time updates)
- ✅ Integrate with existing Queue system
- ✅ Add API documentation (Swagger)

**Next Steps (Phase 8: Testing & Validation):**
- ~~Unit tests (profile validation, stream processing, command generation)~~ ✓ (partial - stream processors done)
- Integration tests (end-to-end encoding, multi-node distribution)
- Production validation (encode test files from 16,000+ library)
- Performance benchmarking
- Stress testing (100+ concurrent jobs)

---

### 2026-02-04: Stream Processor Unit Tests (Phase 8)

**Task Completed:** Add unit tests for stream processing classes

**Changes Made:**

1. Created `StreamProcessorTests.cs` in `tests/NoMercy.Tests.EncoderV2/Streams/`
   - 32 unit tests covering stream processor functionality
   - Tests organized by processor type with clear naming conventions

2. **VideoStreamProcessor Tests (13 tests):**
   - `BuildVideoFilterChain_NoScalingNeeded_ReturnsEmptyList`
   - `BuildVideoFilterChain_ScalingNeeded_ReturnsScaleFilter`
   - `BuildVideoFilterChain_WidthChangeOnly_ReturnsScaleFilter`
   - `BuildVideoFilterChain_HeightChangeOnly_ReturnsScaleFilter`
   - `BuildVideoFilterChain_HdrToSdrConversion_ReturnsToneMapFilters`
   - `BuildVideoFilterChain_HdrToSdrNotRequested_NoToneMapFilters`
   - `BuildVideoFilterChain_SdrWithConversionRequested_NoToneMapFilters`
   - `BuildVideoFilterChain_ScalingAndHdrConversion_ReturnsBothFilters`
   - Parameterized tests for common downscale scenarios (4K→1080p, 1080p→720p, etc.)

3. **AudioStreamProcessor Tests (10 tests):**
   - `BuildAudioFilterChain_NoChangesNeeded_ReturnsEmptyList`
   - `BuildAudioFilterChain_SampleRateChange_ReturnsResampleFilter`
   - `BuildAudioFilterChain_ChannelDownmix_ReturnsPanFilter`
   - `BuildAudioFilterChain_BothChanges_ReturnsBothFilters`
   - `BuildAudioFilterChain_ZeroTargetSampleRate_NoResampleFilter`
   - `BuildAudioFilterChain_ZeroTargetChannels_NoPanFilter`
   - Parameterized tests for common sample rate conversions

4. **SubtitleStreamProcessor Tests (9 tests):**
   - `RequiresConversion_SameCodec_ReturnsFalse`
   - `RequiresConversion_DifferentCodecs_ReturnsTrue`
   - `RequiresConversion_SubripToSrt_ReturnsFalse` (codec normalization)
   - `RequiresConversion_CaseInsensitive_ReturnsFalse`
   - `RequiresConversion_AssToWebvtt_ReturnsTrue`
   - `RequiresConversion_SsaToAss_ReturnsTrue`
   - Parameterized tests for common subtitle conversions

5. Updated `NoMercy.Tests.EncoderV2.csproj`:
   - Added project reference to `NoMercy.Encoder` for FFprobe DTOs

**Test Results:**
- All 32 new tests: PASSED
- All 219 total tests: PASSED
- Duration: 297ms

**Build Status:**
- NoMercy.Tests.EncoderV2: BUILD SUCCEEDED

**Phase 8 Progress (Testing & Validation):**
- ✅ Stream processor unit tests (32 tests)
- ✅ Profile validation tests (pre-existing)
- ✅ Command generation tests (pre-existing)
- ✅ Codec tests (pre-existing)
- ✅ Container tests (pre-existing)
- ❌ Integration tests (end-to-end encoding)
- ❌ Multi-node distribution tests
- ❌ Production validation
- ❌ Performance benchmarking
- ❌ Stress testing

**Next Steps:**
- Continue with integration tests for end-to-end encoding workflows

---

### 2026-02-04: Pipeline Integration Tests (Phase 8)

**Task Completed:** Add integration tests for EncoderV2 pipeline components

**Changes Made:**

1. Created `EncodingPipelineIntegrationTests.cs` in `tests/NoMercy.Tests.EncoderV2/Integration/`
   - 13 integration tests for pipeline components
   - Uses InMemory database via TestQueueContext to avoid SQLite conflicts

2. Created `TestQueueContext` helper class:
   - Inherits from `QueueContext` to override `OnConfiguring()`
   - Prevents SQLite configuration conflict with InMemory provider
   - Enables isolated database testing per test method

3. **Node Selector Tests (5 tests):**
   - `NodeSelector_SelectNode_ReturnsHealthyNode`: Verifies healthy node selection
   - `NodeSelector_WithGpuRequirement_PrefersGpuNodes`: Tests GPU preference with BestCapability strategy
   - `NodeSelector_SelectNodesForTasks_AssignsAllTasks`: Tests batch task assignment
   - `NodeSelector_LeastLoadedStrategy_BalancesLoad`: Verifies load balancing across nodes
   - `NodeSelector_NoHealthyNodes_ReturnsFailure`: Tests failure case handling

4. **Job Lifecycle Database Tests (8 tests):**
   - `JobLifecycle_CancelJob_UpdatesJobAndTaskStates`: Tests job cancellation flow
   - `JobLifecycle_RetryFailedTasks_ResetsTaskState`: Tests retry mechanism
   - `JobLifecycle_GetJobStatus_ReturnsAggregatedProgress`: Tests progress aggregation
   - `JobLifecycle_TaskStateTransitions_UpdatesCorrectly`: Tests state machine transitions
   - `JobLifecycle_RecordProgress_StoresProgressSnapshot`: Tests progress recording
   - `JobLifecycle_ReassignTasksFromNode_ResetsTasksToUnassigned`: Tests node failure handling
   - `JobLifecycle_TaskDependencies_RespectsExecutionOrder`: Tests dependency blocking
   - `JobLifecycle_FailTask_MarksTaskAndJobAsFailed`: Tests failure propagation

**Test Results:**
- All 13 new tests: PASSED
- Test duration: ~4.7 seconds

**Build Status:**
- NoMercy.Tests.EncoderV2: BUILD SUCCEEDED

**Phase 8 Progress (Testing & Validation):**
- ✅ Stream processor unit tests (32 tests)
- ✅ Profile validation tests (pre-existing)
- ✅ Command generation tests (pre-existing)
- ✅ Codec tests (pre-existing)
- ✅ Container tests (pre-existing)
- ✅ Integration tests (node selector, job lifecycle) - 13 tests
- ❌ End-to-end encoding integration tests
- ❌ Multi-node distribution tests
- ❌ Production validation
- ❌ Performance benchmarking
- ❌ Stress testing

**Next Steps:**
- ~~Add end-to-end encoding integration tests~~ ✓
- Add multi-node distribution tests

---

### 2026-02-04: End-to-End Encoding Integration Tests (Phase 8)

**Task Completed:** Add end-to-end encoding integration tests

**Changes Made:**

1. Created `EndToEndEncodingTests.cs` in `tests/NoMercy.Tests.EncoderV2/Integration/`
   - 11 integration tests covering full encoding workflow
   - Uses InMemory database via TestQueueContext (shared from EncodingPipelineIntegrationTests)
   - Tests real service implementations (CodecFactory, ContainerFactory, HLSPlaylistGenerator)

2. **Job Lifecycle E2E Tests (6 tests):**
   - `JobLifecycle_CreateExecuteComplete_FullWorkflow`: Full workflow from job creation through task execution to completion, with progress recording and final state validation
   - `JobLifecycle_TaskFailureAndRetry_Recovers`: Task failure with retry counting, recovery on second attempt
   - `JobLifecycle_NodeFailure_TasksReassigned`: Node health failure with task reassignment to unassigned pool
   - `JobLifecycle_MultipleJobs_ExecuteConcurrently`: 3 concurrent jobs with independent task execution
   - `JobLifecycle_ProgressTracking_RecordsMultipleSnapshots`: 4 progress snapshots with FPS/speed metrics verification
   - `JobLifecycle_PriorityOrdering_HigherPriorityProcessedFirst`: Priority-based job ordering (High > Medium > Low)

3. **HLS Playlist Generator Tests (2 tests):**
   - `HLSPlaylistGenerator_WriteMediaPlaylist_CreatesValidContent`: Generates media playlist with segments, validates #EXTM3U, version, target duration, playlist type, endlist tags
   - `HLSPlaylistGenerator_WriteMasterPlaylist_CreatesValidContent`: Generates master playlist with variant streams (1080p/720p), validates bandwidth, resolution, codec strings

4. **Codec and Container Factory Tests (3 tests):**
   - `CodecFactory_CreateVideoCodec_ReturnsCorrectCodec`: Tests h264→libx264, hevc→libx265, av1→libaom-av1
   - `CodecFactory_CreateAudioCodec_ReturnsCorrectCodec`: Tests aac→aac, opus→libopus
   - `ContainerFactory_CreateContainer_ReturnsCorrectContainer`: Tests hls, mp4, mkv creation

**Test Results:**
- All 11 new tests: PASSED
- Test duration: ~4.6 seconds

**Build Status:**
- NoMercy.Tests.EncoderV2: BUILD SUCCEEDED

**Phase 8 Progress (Testing & Validation):**
- ✅ Stream processor unit tests (32 tests)
- ✅ Profile validation tests (pre-existing)
- ✅ Command generation tests (pre-existing)
- ✅ Codec tests (pre-existing)
- ✅ Container tests (pre-existing)
- ✅ Integration tests (node selector, job lifecycle) - 13 tests
- ✅ End-to-end encoding integration tests - 11 tests
- ✅ Multi-node distribution tests - 21 tests
- ❌ Production validation
- ❌ Performance benchmarking
- ❌ Stress testing

**Next Steps:**
- ~~Add multi-node distribution tests~~ ✓
- Add production validation tests

---

### 2026-02-04: Multi-Node Distribution Tests (Phase 8)

**Task Completed:** Add multi-node distribution integration tests

**Changes Made:**

1. Created `MultiNodeDistributionTests.cs` in `tests/NoMercy.Tests.EncoderV2/Integration/`
   - 21 integration tests covering distributed encoding across multiple encoder nodes
   - Uses InMemory database via TestQueueContext (shared from EncodingPipelineIntegrationTests)
   - Tests real NodeSelector and NodeHealthMonitor implementations with fast timeouts

2. **Task Distribution Tests (4 tests):**
   - `Distribution_TasksDistributedAcrossMultipleNodes_NoSingleNodeOverloaded`: Verifies 10 tasks spread across 5-node heterogeneous cluster without exceeding MaxConcurrentTasks
   - `Distribution_GpuTasksPreferGpuNodes_CpuTasksAcceptAnyNode`: GPU tasks routed to GPU nodes with StrictGpuRequirement, CPU tasks flexible
   - `Distribution_HighMemoryTasks_OnlyAssignedToHighMemoryNodes`: 48GB memory requirement filters to only qualifying nodes
   - `Distribution_MixedWorkload_BalancesAcrossNodeTypes`: Realistic job (HDR, 3 video qualities, 2 audio tracks, subtitles, post-processing) balanced across node types

3. **Health Monitoring Tests (5 tests):**
   - `HealthMonitor_HealthCheckDetectsStaleHeartbeat_MarksNodeUnhealthy`: Stale heartbeat detection marks node unhealthy
   - `HealthMonitor_RecordHeartbeat_RecoversUnhealthyNode`: Heartbeat from unhealthy node triggers recovery
   - `HealthMonitor_UnhealthyNodeWithRunningTasks_TasksReassigned`: Health check detects failure and reassigns 2 tasks
   - `HealthMonitor_DisableNode_ReassignsTasksAndPreventsNewAssignment`: Admin disable reassigns tasks, excludes from selection
   - `HealthMonitor_GetNodeSummary_ReturnsAccurateStatistics`: Cluster summary (4 nodes: 2 healthy, 1 unhealthy, 1 disabled)

4. **Node Failure and Recovery Tests (2 tests):**
   - `NodeFailover_MultipleNodesInCluster_TasksRedistributedToSurvivors`: 3-node cluster, Node-2 fails, tasks reassigned, surviving nodes pick them up
   - `NodeRecovery_NodeComesBackOnline_BecomesAvailableForSelection`: Unhealthy node sends heartbeat, recovers, becomes selectable again

5. **Concurrent Multi-Job Tests (2 tests):**
   - `ConcurrentJobs_MultipleJobsCompeteForNodes_TasksDistributedFairly`: 3 concurrent jobs, 6 total tasks, distributed across 3 workers respecting capacity
   - `ConcurrentJobs_HighPriorityJobGetsNodeFirst_LowerPriorityWaits`: Priority=100 (urgent) processed before Priority=-10 (batch) despite older creation time

6. **Capability Scoring Tests (3 tests):**
   - `Scoring_NvidiaGpuNode_ScoresHigherThanCpuNodeForVideoEncoding`: NVIDIA GPU node scores higher for video encoding
   - `Scoring_PartiallyLoadedNode_ScoresLowerThanIdleNode`: Idle node (0/4 tasks) outscores loaded node (3/4 tasks)
   - `Scoring_AutoStrategy_SelectsBestCapabilityForGpuTasks`: Auto strategy selects BestCapability for HDR/GPU, RoundRobin for light tasks

7. **Edge Case Tests (5 tests):**
   - `EdgeCase_SingleNodeCluster_AllTasksGoToSingleNode`: All 5 tasks assigned to single node
   - `EdgeCase_AllNodesAtCapacity_TasksRemainUnassigned`: Full nodes with ExcludeFullNodes returns failure
   - `EdgeCase_EmptyNodeList_ReturnsFailure`: Empty node list handled gracefully
   - `EdgeCase_FilterHealthyNodes_ExcludesDisabledAndStaleNodes`: Only enabled+healthy+recent heartbeat nodes pass filter
   - `EdgeCase_NodeRecoversAndCompletedTasksUntouched`: Node failure only reassigns running tasks, completed tasks preserved

**Test Results:**
- All 21 new tests: PASSED
- Test duration: ~4.1 seconds

**Build Status:**
- NoMercy.Tests.EncoderV2: BUILD SUCCEEDED

**Phase 8 Progress (Testing & Validation):**
- ✅ Stream processor unit tests (32 tests)
- ✅ Profile validation tests (pre-existing)
- ✅ Command generation tests (pre-existing)
- ✅ Codec tests (pre-existing)
- ✅ Container tests (pre-existing)
- ✅ Integration tests (node selector, job lifecycle) - 13 tests
- ✅ End-to-end encoding integration tests - 11 tests
- ✅ Multi-node distribution tests - 21 tests
- ❌ Production validation
- ❌ Performance benchmarking
- ❌ Stress testing

**Next Steps:**
- Add production validation tests
