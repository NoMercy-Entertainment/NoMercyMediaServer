name: 'Version and Release Management'

on:
  workflow_call:
    outputs:
      version:
        description: 'Calculated version for the next release'
        value: ${{ jobs.version_management.outputs.version }}
      should_deploy:
        description: 'Whether deployment should proceed'
        value: ${{ jobs.version_management.outputs.should_deploy }}

jobs:
  version_management:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.calc-version.outputs.new_version }}
      should_deploy: ${{ steps.check-deploy.outputs.should_deploy }}

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Get latest tag
        id: get-tag
        uses: WyriHaximus/github-action-get-previous-tag@v1
        with:
          fallback: v0.1.201

      - name: Check for source changes
        id: check-changes
        if: github.ref == 'refs/heads/dev'
        run: |
          if [[ "${{ github.event_name }}" == "release" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "has_source_changes=true" >> $GITHUB_OUTPUT
            echo "Release or manual trigger - proceeding with full pipeline"
          else
            # Check for actual source code changes since last tag
            LATEST_TAG="${{ steps.get-tag.outputs.tag }}"
            if git diff --quiet "$LATEST_TAG" HEAD -- src/ 2>/dev/null; then
              echo "has_source_changes=false" >> $GITHUB_OUTPUT
              echo "No source code changes detected since $LATEST_TAG"
            else
              echo "has_source_changes=true" >> $GITHUB_OUTPUT
              echo "Source code changes detected - proceeding with version bump and full pipeline"
            fi
          fi

      - name: Calculate new version
        id: calc-version
        if: steps.check-changes.outputs.has_source_changes == 'true'
        run: |
          LATEST_TAG="${{ steps.get-tag.outputs.tag }}"
          VERSION_NO_V=${LATEST_TAG#v}
          MAJOR=$(echo "$VERSION_NO_V" | cut -d. -f1)
          MINOR=$(echo "$VERSION_NO_V" | cut -d. -f2)
          PATCH=$(echo "$VERSION_NO_V" | cut -d. -f3)
          NEW_PATCH=$(($PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Calculated new version: $NEW_VERSION (from tag $LATEST_TAG)"

      - name: Check deployment conditions
        id: check-deploy
        run: |
          if [[ "${{ github.event_name }}" == "release" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/dev" ]] && [[ "${{ steps.check-changes.outputs.has_source_changes }}" == "true" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi
