name: 'Build Windows Installer'
description: 'Build Windows installer using Inno Setup'
inputs:
  version:
    description: 'Package version'
    required: true
  artifacts-path:
    description: 'Path to build artifacts'
    required: true
    default: './output'

runs:
  using: 'composite'
  steps:
    - name: Install Inno Setup
      shell: pwsh
      run: |
        $InnoUrl = "https://files.jrsoftware.org/is/6/innosetup-6.7.0.exe"
        $InstallerPath = "$env:TEMP\innosetup.exe"

        Write-Host "Downloading Inno Setup 6.7.0..."
        Invoke-WebRequest -Uri $InnoUrl -OutFile $InstallerPath -UseBasicParsing

        Write-Host "Installing Inno Setup..."
        Start-Process -FilePath $InstallerPath -ArgumentList '/VERYSILENT', '/SUPPRESSMSGBOXES', '/DIR=C:\InnoSetup' -Wait -NoNewWindow

        if (Test-Path "C:\InnoSetup\ISCC.exe") {
          Write-Host "Inno Setup installed successfully"
        } else {
          Write-Error "Inno Setup installation failed - ISCC.exe not found"
          exit 1
        }

    - name: Prepare installer artifacts
      shell: pwsh
      run: |
        $IssDir = "./src/NoMercy.Service"
        $ArtifactsPath = "${{ inputs.artifacts-path }}"

        New-Item -ItemType Directory -Force -Path "$IssDir/artifacts" | Out-Null

        $files = @(
          "NoMercyMediaServer-windows-x64.exe",
          "NoMercyMediaServerService-windows-x64.exe",
          "nomercy-windows-x64.exe"
        )

        foreach ($file in $files) {
          $src = Join-Path $ArtifactsPath $file
          if (Test-Path $src) {
            Copy-Item $src "$IssDir/artifacts/"
            Write-Host "Copied: $file"
          } else {
            Write-Warning "Not found: $file"
          }
        }

        Write-Host "Prepared installer artifacts:"
        Get-ChildItem "$IssDir/artifacts/"

    - name: Build Windows Installer
      shell: pwsh
      run: |
        $Version = "${{ inputs.version }}"
        $IssFile = "./src/NoMercy.Service/NoMercyMediaServer.iss"
        $InnoCompiler = "C:\InnoSetup\ISCC.exe"

        New-Item -ItemType Directory -Force -Path "./packages/windows" | Out-Null

        & $InnoCompiler "/DVersion=$Version" "/O./packages/windows" $IssFile

        if ($LASTEXITCODE -ne 0) {
          Write-Error "Inno Setup compilation failed with exit code $LASTEXITCODE"
          exit $LASTEXITCODE
        }

        Write-Host "Windows installer created:"
        Get-ChildItem "./packages/windows/"

    - name: Upload Windows installer artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: packages/windows/
