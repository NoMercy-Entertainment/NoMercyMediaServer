name: 'Build Linux Installer Payload'
description: 'Publish all projects into shared runtime directory for Linux packages'
inputs:
  dotnet-version:
    description: '.NET version to use'
    required: false
    default: '9.0.x'
outputs:
  payload-path:
    description: 'Path to the shared runtime output'
    value: ./installer-payload

runs:
  using: 'composite'
  steps:
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ inputs.dotnet-version }}

    - name: Restore
      shell: bash
      run: dotnet restore NoMercy.Server.sln

    - name: Publish Service (shared runtime)
      shell: bash
      run: |
        dotnet publish ./src/NoMercy.Service/NoMercy.Service.csproj \
          --configuration Release --runtime linux-x64 --self-contained true \
          /p:PublishSingleFile=false /p:DebugType=None /p:DebugSymbols=false \
          --output ./installer-payload

    - name: Publish Tray (shared runtime)
      shell: bash
      run: |
        dotnet publish ./src/NoMercy.Tray/NoMercy.Tray.csproj \
          --configuration Release --runtime linux-x64 --self-contained true \
          /p:PublishSingleFile=false /p:DebugType=None /p:DebugSymbols=false \
          --output ./installer-payload

    - name: Publish CLI (shared runtime)
      shell: bash
      run: |
        dotnet publish ./src/NoMercy.Cli/NoMercy.Cli.csproj \
          --configuration Release --runtime linux-x64 --self-contained true \
          /p:PublishSingleFile=false /p:DebugType=None /p:DebugSymbols=false \
          --output ./installer-payload

    - name: Pull App Files
      uses: actions/checkout@v5
      with:
        repository: NoMercy-Entertainment/NoMercyApp
        path: ./src/NoMercy.App/Resources/wwwroot
        fetch-depth: 1
        fetch-tags: false
        ref: gh-pages

    - name: Move App Files
      shell: bash
      run: |
        mkdir -p ./src/NoMercy.App/wwwroot
        rm -rf ./src/NoMercy.App/Resources/wwwroot/.git
        mv ./src/NoMercy.App/Resources/wwwroot/* ./src/NoMercy.App/wwwroot/ || true
        rm -rf ./src/NoMercy.App/Resources/wwwroot

    - name: Copy InfiniFrame.js to wwwroot
      shell: bash
      run: |
        mkdir -p ./src/NoMercy.App/wwwroot/_content/InfiniLore.InfiniFrame.Js
        NUGET_CACHE="${HOME}/.nuget/packages"
        INFINIFRAME_PKG=$(find "$NUGET_CACHE/infinilore.infiniframe.js" -maxdepth 1 -type d | sort -V | tail -1)
        if [ -d "$INFINIFRAME_PKG/staticwebassets" ]; then
          cp "$INFINIFRAME_PKG/staticwebassets/InfiniFrame.js" "./src/NoMercy.App/wwwroot/_content/InfiniLore.InfiniFrame.Js/"
          echo "InfiniFrame.js copied from $INFINIFRAME_PKG"
        else
          echo "Warning: InfiniFrame.js not found in NuGet cache"
          exit 1
        fi

    - name: Publish App (shared runtime)
      shell: bash
      run: |
        dotnet publish ./src/NoMercy.App/NoMercy.App.csproj \
          --configuration Release --runtime linux-x64 --self-contained true \
          /p:PublishSingleFile=false /p:DebugType=None /p:DebugSymbols=false \
          --output ./installer-payload

    - name: List payload
      shell: bash
      run: |
        FILE_COUNT=$(find ./installer-payload -type f | wc -l)
        TOTAL_SIZE=$(du -sm ./installer-payload | cut -f1)
        echo "Payload: ${FILE_COUNT} files, ${TOTAL_SIZE}MB total"
